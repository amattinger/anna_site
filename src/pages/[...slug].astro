---
import { getCollection, type CollectionEntry } from "astro:content";
import Page from "../templates/Page.astro";
import Contact from "../templates/Contact.astro";
import List from "../templates/List.astro";

export async function getStaticPaths() {
  const pages = await getCollection("pages");
  return pages
    .filter((entry) => entry.slug !== "index" && entry.slug !== "news" && entry.slug !== "sold")
    .map((entry) => {
      const props = {
        entry,
        items: [] as CollectionEntry<"work">[],
        baseSlug: entry.data.templateKey === "work-page" ? "work" : "",
      };
      return {
        params: { slug: entry.slug === "index" ? undefined : entry.slug },
        props,
      };
    });
}

const { entry, items: _pathItems, baseSlug } = Astro.props;
const templateKey = entry.data.templateKey;

// Work list is computed at render time so work-order.ts changes show up immediately (dev and build)
let items = _pathItems;
if (templateKey === "work-page") {
  const { WORK_ORDER } = await import("../data/work-order.ts");
  const workEntries = await getCollection("work");
  const orderMap = new Map(WORK_ORDER.map((slug, i) => [slug, i]));
  items = workEntries
    .filter((e) => orderMap.has(e.slug))
    .sort((a, b) => (orderMap.get(a.slug) ?? 9999) - (orderMap.get(b.slug) ?? 9999));
}
---

{
  templateKey === "contact-page" ? (
    <Contact entry={entry} />
  ) : templateKey === "work-page" ? (
    <List entry={entry} items={items} baseSlug={baseSlug} />
  ) : (
    <Page entry={entry} />
  )
}
