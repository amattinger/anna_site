---
import Layout from '../layouts/Layout.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Fetch collections used on homepage (News and Sold removed from site)
const allPages = await getCollection('pages');
const allWork = await getCollection('work');
const allContent = [...allPages, ...allWork];

// Filter for pagetype containing 'main', exclude Sold and News pages/collections, and sort by number
const posts = allContent.filter(item => {
    if (!item.data.pagetype || !item.data.pagetype.includes('main')) return false;
    if (item.collection === 'sold') return false;
    if (item.collection === 'news') return false;
    if (item.collection === 'pages' && (item.slug === 'sold' || item.slug === 'news')) return false;
    return true;
}).sort((a, b) => {
    const numA = a.data.number || 9999;
    const numB = b.data.number || 9999;
    return numA - numB;
});

// Get index-page metadata (from pages collection)
const indexPage = allPages.find(p => p.slug === 'index');
const title = indexPage?.data.title || 'Anna Mattinger';
const description = indexPage?.data.description;

let postCounter = 0;
---

<Layout title={title} description={description}>
    <div class="post-feed">
        {posts.map((post) => {
            postCounter++;
            // Calculate slug. If it's from 'pages', slug is just slug (or flattened).
            // content/pages/bio.md -> slug 'bio'.
            // content/work/work-1.md -> slug 'work-1'? No, in config.ts, work collection.
            // But legacy mapped work/work-1.md -> /work/work-1
            // My [...slug].astro will handle mapping.
            // Here I need to generate the same link.

            let slug = post.slug;
            if (post.collection === 'work') slug = `work/${post.slug}`;
            // News and Sold removed from site; pages collection: 'bio', 'contact' -> /bio, /contact

            const imagePosition = post.slug === 'bio' ? 'top' : undefined;

            // Legacy slug split logic:
            // src/pages/bio/index.md -> /bio.
            // content/work/work-1.md -> /work/work-1.

            return (
                <PostCard
                    count={postCounter}
                    post={post}
                    slug={slug}
                    imagePosition={imagePosition}
                />
            );
        })}
    </div>
</Layout>
